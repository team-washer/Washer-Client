name: Deploy to Self-Hosted Server

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]
        types: [closed]

env:
    NODE_VERSION: "18"
    WEB_DIR: "/var/www/html"
    PM2_APP_NAME: "laundry-app"
    NEXT_TELEMETRY_DISABLED: 1

jobs:
    deploy:
        runs-on: self-hosted
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

        steps:
            - name: ðŸš€ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: ðŸ§¹ Clean installation
              run: |
                  npm cache clean --force
                  rm -rf node_modules
                  rm -f package-lock.json

            - name: ðŸ“¥ Install dependencies with retry
              run: |
                  # ì²« ë²ˆì§¸ ì‹œë„
                  npm install --legacy-peer-deps --no-audit --no-fund || {
                    echo "First install failed, cleaning and retrying..."
                    rm -rf node_modules
                    npm cache clean --force
                    # ë‘ ë²ˆì§¸ ì‹œë„
                    npm install --legacy-peer-deps --no-audit --no-fund --verbose
                  }

            - name: ðŸ” Verify installation
              run: |
                  echo "Checking installed packages..."
                  ls -la node_modules/@radix-ui/ | head -10
                  npm list --depth=0 | grep radix || echo "No radix packages found"

            - name: ðŸ§ª Run tests
              run: npm test --if-present
              continue-on-error: true

            - name: ðŸ—ï¸ Build application
              run: |
                  export NEXT_TELEMETRY_DISABLED=1
                  npm run build
              env:
                  NODE_ENV: production
                  NEXT_TELEMETRY_DISABLED: 1

            - name: ðŸ›‘ Stop existing PM2 process
              run: |
                  if pm2 list | grep -q "${{ env.PM2_APP_NAME }}"; then
                    pm2 stop ${{ env.PM2_APP_NAME }}
                    pm2 delete ${{ env.PM2_APP_NAME }}
                  fi
              continue-on-error: true

            - name: ðŸ’¾ Backup current deployment
              run: |
                  if [ -d "${{ env.WEB_DIR }}" ]; then
                    sudo cp -r ${{ env.WEB_DIR }} ${{ env.WEB_DIR }}.backup.$(date +%Y%m%d_%H%M%S)
                  fi
              continue-on-error: true

            - name: ðŸ—‘ï¸ Clear web directory
              run: sudo rm -rf ${{ env.WEB_DIR }}/*

            - name: ðŸ“‚ Deploy files
              run: |
                  # Next.js standalone ë°°í¬
                  if [ -d ".next/standalone" ]; then
                    echo "Deploying Next.js standalone..."
                    sudo cp -r .next/standalone/* ${{ env.WEB_DIR }}/
                    sudo cp -r .next/static ${{ env.WEB_DIR }}/.next/
                    sudo cp -r public ${{ env.WEB_DIR }}/
                    
                    # PM2ë¡œ Next.js ì„œë²„ ì‹œìž‘
                    cd ${{ env.WEB_DIR }}
                    pm2 start server.js --name ${{ env.PM2_APP_NAME }} --env production
                    pm2 save
                    
                  else
                    echo "Deploying static files..."
                    # ì •ì  íŒŒì¼ ë°°í¬ (exportê°€ ìžˆëŠ” ê²½ìš°)
                    if [ -d "out" ]; then
                      sudo cp -r out/* ${{ env.WEB_DIR }}/
                    else
                      sudo cp -r .next/static ${{ env.WEB_DIR }}/_next/
                      sudo cp -r public/* ${{ env.WEB_DIR }}/
                    fi
                  fi

            - name: ðŸ” Set permissions
              run: |
                  sudo chown -R www-data:www-data ${{ env.WEB_DIR }}
                  sudo chmod -R 755 ${{ env.WEB_DIR }}

            - name: ðŸ”„ Restart nginx
              run: |
                  sudo nginx -t
                  sudo systemctl reload nginx

            - name: âœ… Health check
              run: |
                  sleep 5
                  # PM2 ì•±ì´ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
                  if pm2 list | grep -q "${{ env.PM2_APP_NAME }}"; then
                    curl -f http://localhost:3000 || curl -f http://localhost
                  else
                    curl -f http://localhost
                  fi

            - name: ðŸ§¹ Cleanup old backups
              run: |
                  cd $(dirname ${{ env.WEB_DIR }})
                  sudo find . -name "html.backup.*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
              continue-on-error: true

            - name: ðŸ“Š Deployment summary
              if: always()
              run: |
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY

                  if [ ${{ job.status }} == 'success' ]; then
                    echo "âœ… **Deployment successful!**" >> $GITHUB_STEP_SUMMARY
                    echo "ðŸŒ **Site URL:** http://your-domain.com" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ **Deployment failed!**" >> $GITHUB_STEP_SUMMARY
                  fi

                  # PM2 ìƒíƒœ í™•ì¸
                  if command -v pm2 &> /dev/null; then
                    echo "### PM2 Status" >> $GITHUB_STEP_SUMMARY
                    echo '\`\`\`' >> $GITHUB_STEP_SUMMARY
                    pm2 list >> $GITHUB_STEP_SUMMARY
                    echo '\`\`\`' >> $GITHUB_STEP_SUMMARY
                  fi
