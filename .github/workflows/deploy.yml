name: Deploy to Self-Hosted Server

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]
        types: [closed]

env:
    NODE_VERSION: "18"
    WEB_DIR: "/var/www/html"
    PM2_APP_NAME: "laundry-app"
    NEXT_TELEMETRY_DISABLED: 1

jobs:
    deploy:
        runs-on: self-hosted
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

        steps:
            - name: ðŸš€ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: ðŸ§¹ Clean installation
              run: |
                  npm cache clean --force
                  rm -rf node_modules
                  rm -f package-lock.json

            - name: ðŸ“¥ Install dependencies with retry
              run: |
                  # ì²« ë²ˆì§¸ ì‹œë„
                  npm install --legacy-peer-deps --no-audit --no-fund || {
                    echo "First install failed, cleaning and retrying..."
                    rm -rf node_modules
                    npm cache clean --force
                    # ë‘ ë²ˆì§¸ ì‹œë„
                    npm install --legacy-peer-deps --no-audit --no-fund --verbose
                  }

            - name: ðŸ” Verify installation
              run: |
                  echo "Checking installed packages..."
                  ls -la node_modules/@radix-ui/ | head -10
                  npm list --depth=0 | grep radix || echo "No radix packages found"

            - name: ðŸ§ª Run tests
              run: npm test --if-present
              continue-on-error: true

            - name: ðŸ—ï¸ Build application
              run: |
                  export NEXT_TELEMETRY_DISABLED=1
                  npm run build
              env:
                  NODE_ENV: production
                  NEXT_TELEMETRY_DISABLED: 1

            - name: ðŸ›‘ Stop existing PM2 process
              run: |
                  if pm2 list | grep -q "${{ env.PM2_APP_NAME }}"; then
                    pm2 stop ${{ env.PM2_APP_NAME }}
                    pm2 delete ${{ env.PM2_APP_NAME }}
                  fi
              continue-on-error: true

            - name: ðŸ’¾ Backup current deployment
              run: |
                  if [ -d "${{ env.WEB_DIR }}" ]; then
                    sudo cp -r ${{ env.WEB_DIR }} ${{ env.WEB_DIR }}.backup.$(date +%Y%m%d_%H%M%S)
                  fi
              continue-on-error: true

            - name: ðŸ—‘ï¸ Clear web directory
              run: sudo rm -rf ${{ env.WEB_DIR }}/*

            - name: ðŸ“‚ Deploy files
              run: |
                  # Next.js standalone ë°°í¬
                  if [ -d ".next/standalone" ]; then
                    echo "âœ… Deploying Next.js standalone..."
                    sudo cp -r .next/standalone/* ${{ env.WEB_DIR }}/
                    sudo cp -r .next/static ${{ env.WEB_DIR }}/.next/
                    sudo cp -r public ${{ env.WEB_DIR }}/
                    
                    # PM2ë¡œ Next.js ì„œë²„ ì‹œìž‘
                    cd ${{ env.WEB_DIR }}
                    echo "ðŸš€ Starting PM2 process..."
                    pm2 start server.js --name ${{ env.PM2_APP_NAME }} --env production
                    pm2 save
                    
                  else
                    echo "ðŸ“ Deploying static files..."
                    # ì •ì  íŒŒì¼ ë°°í¬ (exportê°€ ìžˆëŠ” ê²½ìš°)
                    if [ -d "out" ]; then
                      sudo cp -r out/* ${{ env.WEB_DIR }}/
                    else
                      sudo cp -r .next/static ${{ env.WEB_DIR }}/_next/
                      sudo cp -r public/* ${{ env.WEB_DIR }}/
                    fi
                  fi

            - name: ðŸ” Set permissions
              run: |
                  sudo chown -R www-data:www-data ${{ env.WEB_DIR }}
                  sudo chmod -R 755 ${{ env.WEB_DIR }}

            - name: ðŸ”„ Restart nginx
              run: |
                  sudo nginx -t
                  sudo systemctl reload nginx

            - name: ðŸ” Debug deployment status
              run: |
                  echo "=== PM2 Status ==="
                  pm2 list
                  echo ""
                  echo "=== PM2 Logs (last 20 lines) ==="
                  pm2 logs ${{ env.PM2_APP_NAME }} --lines 20 || echo "No PM2 logs available"
                  echo ""
                  echo "=== Web Directory Contents ==="
                  ls -la ${{ env.WEB_DIR }}
                  echo ""
                  echo "=== Nginx Status ==="
                  sudo systemctl status nginx --no-pager -l
                  echo ""
                  echo "=== Port Usage ==="
                  sudo netstat -tlnp | grep -E ':80|:3000' || echo "No processes on ports 80/3000"

            - name: âœ… Health check with improved error handling
              run: |
                  echo "ðŸ” Starting health check..."
                  sleep 10

                  # PM2 ì•± ìƒíƒœ í™•ì¸
                  if pm2 list | grep -q "${{ env.PM2_APP_NAME }}"; then
                    echo "âœ… PM2 process is running"
                    
                    # PM2 ì•±ì´ ì‹¤ì œë¡œ ï¿½ï¿½ï¿½ë‹µí•˜ëŠ”ì§€ í™•ì¸
                    if curl -f -s --connect-timeout 5 http://localhost:3000 > /dev/null; then
                      echo "âœ… Next.js server is responding on port 3000"
                    else
                      echo "âŒ Next.js server not responding on port 3000"
                      echo "PM2 logs:"
                      pm2 logs ${{ env.PM2_APP_NAME }} --lines 10
                    fi
                    
                    # nginxë¥¼ í†µí•œ ì ‘ê·¼ í™•ì¸
                    if curl -f -s --connect-timeout 5 http://localhost > /dev/null; then
                      echo "âœ… Nginx is serving the application"
                    else
                      echo "âŒ Nginx not serving properly"
                      echo "Nginx error log:"
                      sudo tail -10 /var/log/nginx/error.log || echo "No nginx error log"
                    fi
                    
                  else
                    echo "âŒ PM2 process not found"
                    
                    # ì •ì  íŒŒì¼ ë°°í¬ì¸ ê²½ìš° nginxë§Œ í™•ì¸
                    if curl -f -s --connect-timeout 5 http://localhost > /dev/null; then
                      echo "âœ… Static files served by nginx"
                    else
                      echo "âŒ Static files not accessible"
                      echo "Nginx error log:"
                      sudo tail -10 /var/log/nginx/error.log || echo "No nginx error log"
                      exit 1
                    fi
                  fi

            - name: ðŸ§¹ Cleanup old backups
              run: |
                  cd $(dirname ${{ env.WEB_DIR }})
                  sudo find . -name "html.backup.*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
              continue-on-error: true

            - name: ðŸ“Š Deployment summary
              if: always()
              run: |
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY

                  if [ ${{ job.status }} == 'success' ]; then
                    echo "âœ… **Deployment successful!**" >> $GITHUB_STEP_SUMMARY
                    echo "ðŸŒ **Site URL:** http://your-domain.com" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "âŒ **Deployment failed!**" >> $GITHUB_STEP_SUMMARY
                  fi

                  # PM2 ìƒíƒœ í™•ì¸
                  if command -v pm2 &> /dev/null; then
                    echo "### PM2 Status" >> $GITHUB_STEP_SUMMARY
                    echo '\`\`\`' >> $GITHUB_STEP_SUMMARY
                    pm2 list >> $GITHUB_STEP_SUMMARY
                    echo '\`\`\`' >> $GITHUB_STEP_SUMMARY
                  fi

                  # ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
                  echo "### System Status" >> $GITHUB_STEP_SUMMARY
                  echo '\`\`\`' >> $GITHUB_STEP_SUMMARY
                  echo "Nginx: $(sudo systemctl is-active nginx)" >> $GITHUB_STEP_SUMMARY
                  echo "Disk usage: $(df -h ${{ env.WEB_DIR }} | tail -1)" >> $GITHUB_STEP_SUMMARY
                  echo '\`\`\`' >> $GITHUB_STEP_SUMMARY
