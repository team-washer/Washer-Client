name: Deploy to Self-Hosted Server

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    build-and-deploy:
        runs-on: self-hosted

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build application
              run: npm run build
              env:
                  NODE_ENV: production

            - name: Run tests (optional)
              run: npm test --if-present
              continue-on-error: true

            - name: Stop nginx (if needed for deployment)
              run: sudo systemctl stop nginx
              continue-on-error: true

            - name: Backup current deployment
              run: |
                  if [ -d "/var/www/html" ]; then
                    sudo cp -r /var/www/html /var/www/html.backup.$(date +%Y%m%d_%H%M%S)
                  fi
              continue-on-error: true

            - name: Clear web directory
              run: sudo rm -rf /var/www/html/*

            - name: Deploy to web directory
              run: |
                  sudo cp -r .next/standalone/* /var/www/html/
                  sudo cp -r .next/static /var/www/html/.next/
                  sudo cp -r public /var/www/html/

            - name: Set proper permissions
              run: |
                  sudo chown -R www-data:www-data /var/www/html
                  sudo chmod -R 755 /var/www/html

            - name: Start nginx
              run: sudo systemctl start nginx

            - name: Verify nginx status
              run: sudo systemctl status nginx

            - name: Health check
              run: |
                  sleep 5
                  curl -f http://localhost || exit 1

            - name: Cleanup old backups (keep last 5)
              run: |
                  cd /var/www
                  sudo ls -t html.backup.* 2>/dev/null | tail -n +6 | sudo xargs rm -rf
              continue-on-error: true

            - name: Notify deployment status
              if: always()
              run: |
                  if [ ${{ job.status }} == 'success' ]; then
                    echo "✅ Deployment successful!"
                  else
                    echo "❌ Deployment failed!"
                    exit 1
                  fi
